name: Build and Push

on:
  push:
    branches:
      - main

concurrency:
  group: build-production
  cancel-in-progress: true

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: study_cards_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/study_cards_test
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
        run: ./gradlew test --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/test/

  build-and-push:
    name: Build and Push
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Backup latest tag as previous
        continue-on-error: true
        env:
          IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/study-cards-app
        run: |
          set -euo pipefail

          if docker pull "${IMAGE_NAME}:latest"; then
            docker tag "${IMAGE_NAME}:latest" "${IMAGE_NAME}:previous"
            docker push "${IMAGE_NAME}:previous"
            echo "Backed up latest as previous."
          else
            echo "No latest image found. Skipping previous backup."
          fi

      - name: Extract Docker image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/study-cards-app
          tags: |
            type=sha,format=short
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  cleanup-dockerhub-sha-tags:
    name: Cleanup DockerHub SHA Tags
    runs-on: ubuntu-latest
    needs: build-and-push
    if: success()
    continue-on-error: true

    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Remove old SHA tags from DockerHub
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKERHUB_REPOSITORY: study-cards-app
          KEEP_COUNT: 5
        run: |
          set -euo pipefail

          echo "Authenticating to DockerHub API..."
          TOKEN=$(curl -fsS -H "Content-Type: application/json" \
            -X POST https://hub.docker.com/v2/users/login/ \
            -d "{\"username\":\"${DOCKERHUB_USERNAME}\",\"password\":\"${DOCKERHUB_PASSWORD}\"}" \
            | jq -r '.token')

          if [ -z "${TOKEN}" ] || [ "${TOKEN}" = "null" ]; then
            echo "Failed to get DockerHub API token."
            exit 1
          fi

          AUTH_HEADER="Authorization: Bearer ${TOKEN}"

          NEXT_URL="https://hub.docker.com/v2/repositories/${DOCKERHUB_USERNAME}/${DOCKERHUB_REPOSITORY}/tags?page_size=100"
          TAG_ROWS_FILE="$(mktemp)"

          while [ -n "${NEXT_URL}" ] && [ "${NEXT_URL}" != "null" ]; do
            RESPONSE=$(curl -fsS -H "${AUTH_HEADER}" "${NEXT_URL}")
            echo "${RESPONSE}" | jq -r '.results[] | select(.name | startswith("sha-")) | "\(.last_updated)\t\(.name)"' >> "${TAG_ROWS_FILE}"
            NEXT_URL=$(echo "${RESPONSE}" | jq -r '.next')
          done

          if [ ! -s "${TAG_ROWS_FILE}" ]; then
            echo "No SHA tags found. Nothing to clean."
            exit 0
          fi

          mapfile -t SHA_TAGS < <(sort -r "${TAG_ROWS_FILE}" | cut -f2)
          TOTAL_COUNT=${#SHA_TAGS[@]}

          if [ "${TOTAL_COUNT}" -le "${KEEP_COUNT}" ]; then
            echo "SHA tags: ${TOTAL_COUNT}. No cleanup needed."
            exit 0
          fi

          retry() {
            local n=0
            local max=5
            local delay=2
            until "$@"; do
              n=$((n+1))
              if [ "$n" -ge "$max" ]; then
                echo "Command failed after ${n} attempts: $*"
                return 1
              fi
              sleep $delay
              delay=$((delay*2))
            done
          }

          DELETE_COUNT=$((TOTAL_COUNT - KEEP_COUNT))
          echo "Total SHA tags: ${TOTAL_COUNT}, deleting old ${DELETE_COUNT} tags."

          for TAG in "${SHA_TAGS[@]:${KEEP_COUNT}}"; do
            echo "Deleting tag: ${TAG}"
            retry curl -fsS -X DELETE \
              -H "${AUTH_HEADER}" \
              "https://hub.docker.com/v2/repositories/${DOCKERHUB_USERNAME}/${DOCKERHUB_REPOSITORY}/tags/${TAG}/"
          done

          echo "DockerHub SHA tag cleanup complete."
