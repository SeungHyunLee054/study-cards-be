name: Deploy to GCP VM

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  IMAGE_NAME: study-cards-app

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: study_cards_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/study_cards_test
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
        run: ./gradlew test --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/test/

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract Docker image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/study-cards-app
          tags: |
            type=sha,format=short
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract SHA tag for deployment
        id: sha-tag
        run: |
          # Extract short SHA from git commit
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "sha=sha-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Deploying with tag: sha-${SHORT_SHA}"

      - name: Create deployment directory on VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          script: |
            sudo mkdir -p /opt/study-cards
            sudo chown -R ${{ secrets.GCP_VM_USER }}:${{ secrets.GCP_VM_USER }} /opt/study-cards

      - name: Copy deployment files to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          source: docker-compose.prod.yml
          target: /opt/study-cards/

      - name: Create environment file on VM
        uses: appleboy/ssh-action@v1.0.3
        env:
          PRODUCTION_ENV: ${{ secrets.PRODUCTION_ENV }}
          FCM_SERVICE_ACCOUNT_KEY: ${{ secrets.FCM_SERVICE_ACCOUNT_KEY }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          IMAGE_TAG: ${{ steps.sha-tag.outputs.sha }}
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          envs: PRODUCTION_ENV,FCM_SERVICE_ACCOUNT_KEY,DOCKER_USERNAME,IMAGE_TAG
          script: |
            cd /opt/study-cards

            # Create logs directory with proper ownership for container user (UID 1000)
            mkdir -p logs
            sudo chown -R 1000:1000 logs
            sudo chmod -R 755 logs

            # Create .env file from production environment secret
            cat > .env << 'EOF'
            ${PRODUCTION_ENV}
            EOF

            # Append dynamic variables
            echo "IMAGE_TAG=${IMAGE_TAG}" >> .env
            echo "DOCKER_IMAGE=${DOCKER_USERNAME}/study-cards-app:${IMAGE_TAG}" >> .env

            chmod 600 .env

            # Create Firebase service account file from base64 secret
            mkdir -p config
            echo "${FCM_SERVICE_ACCOUNT_KEY}" | base64 -d > config/firebase-service-account.json
            chmod 644 config/firebase-service-account.json

      - name: Deploy on VM
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          IMAGE_TAG: ${{ steps.sha-tag.outputs.sha }}
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          envs: DOCKER_USERNAME,DOCKER_PASSWORD,IMAGE_TAG
          script: |
            cd /opt/study-cards

            # Login to DockerHub securely
            echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin

            # Pull previous image from DockerHub for rollback capability
            docker pull $DOCKER_USERNAME/study-cards-app:previous 2>/dev/null || echo "No previous image available"

            # Pull new image with SHA tag
            echo "Pulling image: $DOCKER_USERNAME/study-cards-app:${IMAGE_TAG}"
            docker pull $DOCKER_USERNAME/study-cards-app:${IMAGE_TAG}

            # Tag SHA image as latest for docker-compose to use
            # Note: DockerHub latest will only be updated after successful verification
            docker tag $DOCKER_USERNAME/study-cards-app:${IMAGE_TAG} \
              $DOCKER_USERNAME/study-cards-app:latest

            # Deploy with minimal downtime (only restart app container)
            # postgres and redis keep running
            docker compose -f docker-compose.prod.yml up -d --no-deps app

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          envs: DOCKER_USERNAME
          script: |
            echo "Checking application health..."
            cd /opt/study-cards

            # Get container ID dynamically from docker compose
            CONTAINER_ID=$(docker compose -f docker-compose.prod.yml ps -q app)

            if [ -z "$CONTAINER_ID" ]; then
              echo "❌ Failed to find app container"
              exit 1
            fi

            echo "Found container: $CONTAINER_ID"
            MAX_ATTEMPTS=30
            ATTEMPT=1

            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' $CONTAINER_ID 2>/dev/null || echo "unknown")

              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Health status: $HEALTH_STATUS"

              if [ "$HEALTH_STATUS" = "healthy" ]; then
                echo "Application is healthy!"
                exit 0
              elif [ "$HEALTH_STATUS" = "unhealthy" ]; then
                echo "Application is unhealthy - rolling back..."
                break
              fi

              # starting or unknown - keep waiting
              sleep 15
              ATTEMPT=$((ATTEMPT + 1))
            done

            echo "Health check failed - rolling back to previous verified version..."
            cd /opt/study-cards

            # Use previous image from DockerHub (always a verified, healthy image)
            if docker image inspect $DOCKER_USERNAME/study-cards-app:previous > /dev/null 2>&1; then
              echo "Rolling back to previous verified image"
              docker tag $DOCKER_USERNAME/study-cards-app:previous \
                $DOCKER_USERNAME/study-cards-app:latest
              # Rollback with minimal downtime
              docker compose -f docker-compose.prod.yml up -d --no-deps app
              echo "✓ Rollback completed"
            else
              echo "❌ No previous image available for rollback!"
            fi
            exit 1

      - name: Update stable image tags after successful deployment
        if: success()
        run: |
          # Only update latest/previous tags after deployment is verified healthy
          echo "Deployment verified - updating stable tags..."

          # Login to DockerHub to pull images
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

          # Backup current latest as previous
          docker pull ${{ secrets.DOCKER_USERNAME }}/study-cards-app:latest 2>/dev/null || true
          if docker image inspect ${{ secrets.DOCKER_USERNAME }}/study-cards-app:latest > /dev/null 2>&1; then
            docker tag ${{ secrets.DOCKER_USERNAME }}/study-cards-app:latest \
              ${{ secrets.DOCKER_USERNAME }}/study-cards-app:previous
            docker push ${{ secrets.DOCKER_USERNAME }}/study-cards-app:previous
            echo "✓ Backed up current latest as previous"
          fi

          # Pull verified SHA image from DockerHub
          echo "Pulling verified image: ${{ steps.sha-tag.outputs.sha }}"
          docker pull ${{ secrets.DOCKER_USERNAME }}/study-cards-app:${{ steps.sha-tag.outputs.sha }}

          # Promote verified SHA image to latest
          docker tag ${{ secrets.DOCKER_USERNAME }}/study-cards-app:${{ steps.sha-tag.outputs.sha }} \
            ${{ secrets.DOCKER_USERNAME }}/study-cards-app:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/study-cards-app:latest
          echo "✓ Promoted ${{ steps.sha-tag.outputs.sha }} to latest"

      - name: Notify deployment success
        if: success()
        run: |
          echo "Deployment successful!"
          echo "Version: ${{ github.sha }}"
          echo "Image: ${{ steps.sha-tag.outputs.sha }}"
          echo "Commit: ${{ github.event.head_commit.message }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "Deployment failed!"
          echo "Check logs for details"

  cleanup-old-images:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()

    steps:
      - name: Cleanup old Docker images on VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          script: |
            echo "Cleaning up old Docker images..."

            # Remove dangling images
            docker image prune -f

            # Keep: latest, previous, and last 5 SHA tags (by creation date)
            # Remove older SHA-tagged images
            docker images --format "{{.CreatedAt}}\t{{.Repository}}:{{.Tag}}" | \
              grep "study-cards-app:sha-" | \
              sort -r | \
              tail -n +6 | \
              awk '{print $2}' | \
              xargs -r docker rmi 2>/dev/null || true

            echo "Cleanup completed"

            # Show remaining images
            echo "Remaining study-cards-app images:"
            docker images | grep study-cards-app || echo "No study-cards-app images found"
