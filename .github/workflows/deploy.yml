name: Deploy to GCP VM

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  IMAGE_NAME: study-cards-app

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: study_cards_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/study_cards_test
          SPRING_DATASOURCE_USERNAME: test
          SPRING_DATASOURCE_PASSWORD: test
          SPRING_DATA_REDIS_HOST: localhost
          SPRING_DATA_REDIS_PORT: 6379
        run: ./gradlew test --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/test/

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to DockerHub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Extract Docker image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/study-cards-app
          tags: |
            type=sha
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create deployment directory on VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          script: |
            sudo mkdir -p /opt/study-cards
            sudo chown -R ${{ secrets.GCP_VM_USER }}:${{ secrets.GCP_VM_USER }} /opt/study-cards

      - name: Copy deployment files to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          source: docker-compose.prod.yml
          target: /opt/study-cards/

      - name: Create environment file on VM
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          APP_JWT_SECRET: ${{ secrets.APP_JWT_SECRET }}
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          OAUTH2_REDIRECT_URI: ${{ secrets.OAUTH2_REDIRECT_URI }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TOSS_CLIENT_KEY: ${{ secrets.TOSS_CLIENT_KEY }}
          TOSS_SECRET_KEY: ${{ secrets.TOSS_SECRET_KEY }}
          TOSS_WEBHOOK_SECRET: ${{ secrets.TOSS_WEBHOOK_SECRET }}
          SPRINGDOC_SERVER_URL: ${{ secrets.SPRINGDOC_SERVER_URL }}
          FCM_SERVICE_ACCOUNT_KEY: ${{ secrets.FCM_SERVICE_ACCOUNT_KEY }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          envs: DB_NAME,DB_USER,DB_PASSWORD,REDIS_PASSWORD,APP_JWT_SECRET,MAIL_HOST,MAIL_PORT,MAIL_USERNAME,MAIL_PASSWORD,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,KAKAO_CLIENT_ID,KAKAO_CLIENT_SECRET,NAVER_CLIENT_ID,NAVER_CLIENT_SECRET,OAUTH2_REDIRECT_URI,GEMINI_API_KEY,TOSS_CLIENT_KEY,TOSS_SECRET_KEY,TOSS_WEBHOOK_SECRET,SPRINGDOC_SERVER_URL,FCM_SERVICE_ACCOUNT_KEY,DOCKER_USERNAME
          script: |
            cd /opt/study-cards

            # Create .env file with required secrets
            cat > .env << EOF
            DB_PASSWORD=${DB_PASSWORD}
            REDIS_PASSWORD=${REDIS_PASSWORD}
            APP_JWT_SECRET=${APP_JWT_SECRET}
            MAIL_HOST=${MAIL_HOST}
            MAIL_USERNAME=${MAIL_USERNAME}
            MAIL_PASSWORD=${MAIL_PASSWORD}
            GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
            KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
            NAVER_CLIENT_ID=${NAVER_CLIENT_ID}
            NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}
            OAUTH2_REDIRECT_URI=${OAUTH2_REDIRECT_URI}
            GEMINI_API_KEY=${GEMINI_API_KEY}
            TOSS_CLIENT_KEY=${TOSS_CLIENT_KEY}
            TOSS_SECRET_KEY=${TOSS_SECRET_KEY}
            TOSS_WEBHOOK_SECRET=${TOSS_WEBHOOK_SECRET}
            DOCKER_IMAGE=${DOCKER_USERNAME}/study-cards-app:latest
            EOF

            # Append optional secrets (only if set)
            [ -n "${DB_NAME}" ] && echo "DB_NAME=${DB_NAME}" >> .env
            [ -n "${DB_USER}" ] && echo "DB_USER=${DB_USER}" >> .env
            [ -n "${MAIL_PORT}" ] && echo "MAIL_PORT=${MAIL_PORT}" >> .env
            [ -n "${SPRINGDOC_SERVER_URL}" ] && echo "SPRINGDOC_SERVER_URL=${SPRINGDOC_SERVER_URL}" >> .env

            chmod 600 .env

            # Create Firebase service account file from base64 secret
            mkdir -p config
            echo "${FCM_SERVICE_ACCOUNT_KEY}" | base64 -d > config/firebase-service-account.json
            chmod 600 config/firebase-service-account.json

      - name: Deploy on VM
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          envs: DOCKER_USERNAME,DOCKER_PASSWORD
          script: |
            cd /opt/study-cards

            # Backup current image for rollback
            docker tag $DOCKER_USERNAME/study-cards-app:latest $DOCKER_USERNAME/study-cards-app:previous 2>/dev/null || true

            # Pull new image from Docker Hub
            docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
            docker pull $DOCKER_USERNAME/study-cards-app:latest

            # Restart containers
            docker compose -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.prod.yml up -d

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          envs: DOCKER_USERNAME
          script: |
            echo "Checking application health..."
            MAX_ATTEMPTS=24
            ATTEMPT=1
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "Application is healthy!"
                exit 0
              fi
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - waiting..."
              sleep 5
              ATTEMPT=$((ATTEMPT + 1))
            done

            echo "Health check failed - rolling back..."
            cd /opt/study-cards
            docker compose -f docker-compose.prod.yml down || true
            docker tag $DOCKER_USERNAME/study-cards-app:previous $DOCKER_USERNAME/study-cards-app:latest 2>/dev/null || true
            docker compose -f docker-compose.prod.yml up -d
            exit 1

      - name: Notify deployment success
        if: success()
        run: |
          echo "Deployment successful!"
          echo "Version: ${{ github.sha }}"
          echo "Commit: ${{ github.event.head_commit.message }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "Deployment failed!"
          echo "Check logs for details"

  cleanup-old-images:
    name: Cleanup Old Images
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()

    steps:
      - name: Cleanup old Docker images on VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_VM_SSH_KEY }}
          script: |
            echo "Cleaning up old Docker images..."

            # Remove dangling images
            docker image prune -f

            # Remove study-cards-app images except latest and previous
            docker images --format "{{.Repository}}:{{.Tag}}" | \
              grep "study-cards-app" | \
              grep -v -E ':(latest|previous)$' | \
              xargs -r docker rmi 2>/dev/null || true

            echo "Cleanup completed"

            # Show remaining images
            docker images | grep study-cards-app || true
